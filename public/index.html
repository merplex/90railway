<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ninety Service</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #00b900; --bg-grey: #f4f7f6; }
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: var(--bg-grey); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; color: #333; }
        
        .card { background: white; width: 85%; max-width: 400px; padding: 40px 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        
        /* --- Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π‡πÅ‡∏ï‡πâ‡∏° (Dashboard) --- */
        .points-display { font-size: 4rem; font-weight: bold; color: var(--line-green); margin: 10px 0; }
        .label { color: #888; font-size: 1rem; }
        .btn-scan { background-color: var(--line-green); color: white; border: none; padding: 15px; width: 100%; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,185,0,0.3); transition: 0.2s; }
        .btn-scan:active { transform: scale(0.98); background-color: #009900; }

        /* --- Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏≠‡∏á Boss) --- */
        .icon-box { font-size: 60px; margin-bottom: 20px; }
        .status-text { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .detail-text { color: #777; font-size: 0.9rem; line-height: 1.5; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--line-green); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-close { margin-top: 30px; background: #555; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer; display: none; }
        .success-icon { color: var(--line-green); display: none; }
        .error-icon { color: #ff4b4b; display: none; }

        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á 2 ‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏£‡∏≠‡πÄ‡∏ä‡πá‡∏Å URL */
        #dashboardMode, #processMode { display: none; }
    </style>
</head>
<body>

<div id="dashboardMode" class="card">
    <div class="label">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
    <div id="userPoints" class="points-display">...</div>
    <div class="label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    
    <button class="btn-scan" onclick="startScan()">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°</button>
    <div id="dashStatus" style="margin-top:10px; color:red; font-size:0.8rem;"></div>
</div>

<div id="processMode" class="card">
    <div id="loader" class="loader"></div>
    <div id="iconBox" class="icon-box">
        <span id="successIcon" class="success-icon">‚úÖ</span>
        <span id="errorIcon" class="error-icon">‚ùå</span>
    </div>
    <div id="statusText" class="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    <div id="detailText" class="detail-text">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
    <button id="btnClose" class="btn-close" onclick="liff.closeWindow()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
</div>

<script>
    // ‚ö†Ô∏è ‡πÉ‡∏™‡πà LIFF ID ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á Boss ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
    const LIFF_ID = "2009026941-FsGWN6uS"; 

    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }

            // ‡πÄ‡∏ä‡πá‡∏Å URL ‡∏ß‡πà‡∏≤‡∏°‡∏µ parameter ‡πÑ‡∏´‡∏°?
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            const token = urlParams.get('token');

            if (action || token) {
                // üëâ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ -> ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Process (Logic ‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏≠‡∏á Boss ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
                document.getElementById('processMode').style.display = 'block';
                await runOldProcessLogic(urlParams);
            } else {
                // üëâ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ -> ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Dashboard (‡∏î‡∏π‡πÅ‡∏ï‡πâ‡∏°)
                document.getElementById('dashboardMode').style.display = 'block';
                await loadPoints();
            }

        } catch (err) {
            alert("LIFF Error: " + err.message);
        }
    }

    // -----------------------------------------------------
    // üü° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 1: ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏≠‡∏á Boss (‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏° / ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°)
    // -----------------------------------------------------
    async function runOldProcessLogic(urlParams) {
        try {
            const profile = await liff.getProfile();
            const userId = profile.userId;
            
            const action = urlParams.get('action');
            const token = urlParams.get('token');
            const amount = urlParams.get('amount');
            const machine_id = urlParams.get('machine_id');

            let apiUrl = "";
            
            // üëá ‡∏ô‡∏µ‡πà‡πÑ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö Logic ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà Boss ‡∏ñ‡∏≤‡∏°‡∏´‡∏≤ ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!
            if (action === "use") {
                // --- ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏±‡∏Å‡πÅ‡∏ï‡πâ‡∏° (Redeem) ---
                document.getElementById('statusText').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡πÅ‡∏ï‡πâ‡∏°...";
                apiUrl = `/liff/redeem-execute?userId=${userId}&amount=${amount}&machine_id=${machine_id}`;
            } else {
                // --- ‡∏ù‡∏±‡πà‡∏á‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏° (Consume) ---
                document.getElementById('statusText').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°...";
                apiUrl = `/liff/consume?token=${token}&userId=${userId}`;
            }

            const response = await fetch(apiUrl);
            const result = await response.text();

            document.getElementById('loader').style.display = 'none';
            document.getElementById('btnClose').style.display = 'inline-block';

            if (response.ok) {
                document.getElementById('successIcon').style.display = 'inline';
                document.getElementById('statusText').innerText = "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!";
                document.getElementById('detailText').innerText = result;
            } else {
                document.getElementById('errorIcon').style.display = 'inline';
                document.getElementById('statusText').innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
                document.getElementById('detailText').innerText = result;
            }
        } catch (err) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('statusText').innerText = "System Error";
            document.getElementById('detailText').innerText = err.message;
        }
    }

    // -----------------------------------------------------
    // üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 2: ‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏î‡∏π‡πÅ‡∏ï‡πâ‡∏° + ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô)
    // -----------------------------------------------------
    async function loadPoints() {
        try {
            const profile = await liff.getProfile();
            const response = await fetch(`/api/get-user-points?userId=${profile.userId}`);
            const data = await response.json();
            document.getElementById('userPoints').innerText = data.points;
        } catch (err) {
            document.getElementById('dashStatus').innerText = "‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        }
    }

    async function startScan() {
        if (!liff.isInClient()) { alert("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"); return; }
        try {
            const result = await liff.scanCodeV2();
            if (result.value) {
                const qrText = result.value;
                // ‡∏ñ‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏à‡∏≠ QR ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô LIFF Link -> ‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏¢ (‡πÄ‡∏Ç‡πâ‡∏≤ Logic ‡πÄ‡∏Å‡πà‡∏≤)
                if (qrText.includes("liff.line.me")) {
                    window.location.href = qrText;
                } else {
                    alert("QR Code ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: " + qrText);
                }
            }
        } catch (err) {
            alert("Scan Error: " + err);
        }
    }

    main();
</script>

</body>
</html>
