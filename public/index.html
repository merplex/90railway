<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ninety Service</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #00b900; --bg-grey: #f4f7f6; }
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: var(--bg-grey); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; color: #333; }
        .card { background: white; width: 85%; max-width: 400px; padding: 40px 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .icon-box { font-size: 60px; margin-bottom: 20px; }
        .status-text { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .detail-text { color: #777; font-size: 0.9rem; line-height: 1.5; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--line-green); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-close { margin-top: 30px; background: var(--line-green); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer; display: none; }
        .success-icon { color: var(--line-green); display: none; }
        .error-icon { color: #ff4b4b; display: none; }
    </style>
</head>
<body>

<div class="card">
    <div id="loader" class="loader"></div>
    <div id="iconBox" class="icon-box">
        <span id="successIcon" class="success-icon">‚úÖ</span>
        <span id="errorIcon" class="error-icon">‚ùå</span>
    </div>
    <div id="statusText" class="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    <div id="detailText" class="detail-text">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
    <button id="btnClose" class="btn-close" onclick="liff.closeWindow()">‡∏ï‡∏Å‡∏•‡∏á</button>
</div>

<script>
    async function main() {
        try {
            await liff.init({ liffId: "2009026941-FsGWN6uS" }); // üëà ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡πÄ‡∏õ‡∏£‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            const profile = await liff.getProfile();
            const userId = profile.userId;
            const urlParams = new URLSearchParams(window.location.search);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Parameter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏ù‡∏±‡πà‡∏á
            const action = urlParams.get('action'); // 'use' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏Å‡πÅ‡∏ï‡πâ‡∏°
            const token = urlParams.get('token');   // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°
            const amount = urlParams.get('amount');
            const machine_id = urlParams.get('machine_id');

            let apiUrl = "";
            if (action === "use") {
                // --- ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏±‡∏Å‡πÅ‡∏ï‡πâ‡∏° ---
                document.getElementById('statusText').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡πÅ‡∏ï‡πâ‡∏°...";
                apiUrl = `/liff/redeem-execute?userId=${userId}&amount=${amount}&machine_id=${machine_id}`;
            } else {
                // --- ‡∏ù‡∏±‡πà‡∏á‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏° ---
                document.getElementById('statusText').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°...";
                apiUrl = `/liff/consume?token=${token}&userId=${userId}`;
            }

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Backend
            const response = await fetch(apiUrl);
            const result = await response.text();

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            document.getElementById('loader').style.display = 'none';
            document.getElementById('btnClose').style.display = 'inline-block';

            if (response.ok) {
                document.getElementById('successIcon').style.display = 'inline';
                document.getElementById('statusText').innerText = "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!";
                document.getElementById('detailText').innerText = result;
            } else {
                document.getElementById('errorIcon').style.display = 'inline';
                document.getElementById('statusText').innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
                document.getElementById('detailText').innerText = result;
            }

        } catch (err) {
            console.error(err);
            document.getElementById('loader').style.display = 'none';
            document.getElementById('statusText').innerText = "System Error";
            document.getElementById('detailText').innerText = err.message;
        }
    }
    main();
</script>

</body>
</html>